#!/usr/bin/env bash
set -e

# Ensure we're inside a git repo and move to root
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    echo "[push] Not inside a git repository."
    exit 1
}
cd "$REPO_ROOT"

echo "[push] Repo root: $REPO_ROOT"
echo "[push] Branch: $(git branch --show-current)"
echo

# Show what will be staged
echo "[push] Current status:"
git status --short
echo

# Stage everything not ignored
git add -A

# Check if there is anything to commit
if git diff --cached --quiet; then
    echo "[push] Nothing to commit. Working tree clean."
    exit 0
fi

# Ask for commit message
read -rp "[push] Commit message: " MSG
if [[ -z "$MSG" ]]; then
    echo "[push] Aborted. Empty commit message."
    exit 1
fi

# Commit
git commit -m "$MSG"

# Optional SSH sanity check (non-fatal)
echo "[push] Checking SSH access to GitHub..."
ssh -T git@github.com || true
echo

# Push current HEAD
echo "[push] Pushing to origin..."
git push origin HEAD

echo "[push] Done."
