#!/usr/bin/env bash
set -e

# -------------------------------------------------
# Paths
# -------------------------------------------------

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VENV_DIR="$ROOT_DIR/.venv"
REQ_FILE="$ROOT_DIR/utils/_Setup/requirements.txt"

echo "[setup] OSPM root: $ROOT_DIR"

# -------------------------------------------------
# Require conda (cluster-safe)
# -------------------------------------------------

if [[ -z "${CONDA_DEFAULT_ENV:-}" ]]; then
    echo "[setup] ERROR: Conda environment not active"
    echo "[setup] Activate with: conda activate ospm"
    exit 2
fi

# -------------------------------------------------
# Python check
# -------------------------------------------------

if ! command -v python3 >/dev/null 2>&1; then
    echo "[setup] ERROR: python3 not found"
    exit 1
fi

# -------------------------------------------------
# Create venv if missing
# -------------------------------------------------

if [ ! -d "$VENV_DIR" ]; then
    echo "[setup] No venv found â€” creating"
    python3 -m venv "$VENV_DIR"
else
    echo "[setup] venv exists"
fi

# -------------------------------------------------
# Activate venv
# -------------------------------------------------

source "$VENV_DIR/bin/activate"

# -------------------------------------------------
# Upgrade pip (never pin on HPC)
# -------------------------------------------------

echo "[setup] Upgrading pip"
pip install --upgrade pip

# -------------------------------------------------
# Install requirements if needed
# -------------------------------------------------

if [ ! -f "$REQ_FILE" ]; then
    echo "[setup] ERROR: requirements file not found:"
    echo "        $REQ_FILE"
    exit 1
fi

echo "[setup] Checking Python dependencies"

python - <<EOF
import sys
import subprocess

required = [
    "numpy",
    "scipy",
    "pandas",
    "matplotlib",
    "astropy",
    "torch",
]

missing = []
for pkg in required:
    try:
        __import__(pkg)
    except ImportError:
        missing.append(pkg)

if missing:
    print("[setup] Missing packages detected:", missing)
    print("[setup] Installing from requirements.txt")
    subprocess.check_call(
        [sys.executable, "-m", "pip", "install", "-r", "$REQ_FILE"]
    )
else:
    print("[setup] All required packages already installed")
EOF

# -------------------------------------------------
# Final verification
# -------------------------------------------------

echo "[setup] Final verification"

python - <<EOF
import sys

required = [
    "numpy",
    "scipy",
    "pandas",
    "matplotlib",
    "astropy",
    "torch",
]

for pkg in required:
    __import__(pkg)

print("[setup] Environment ready")
EOF
